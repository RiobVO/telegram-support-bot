# Internal Support Telegram Bot

Внутренний Telegram-бот для обработки обращений сотрудников компании.  
Используется как единая точка приёма жалоб и заявок от 4500+ сотрудников.

Бот закрывает типовой поток: сотрудник → оформление обращения → регистрация и маршрутизация → работа с обращением в Bitrix24 → аналитика и экспорт.

---

## Основной функционал

- Многошаговая FSM-форма оформления заявки
- Поддержка трёх языков: **RU / UZ / EN**
- Валидация ФИО и телефона
- Выбор категории обращения
- Загрузка вложений (фото, видео, документы, голосовые) до 10 штук
- Формирование карточки обращения с уникальным ID (например, `DEV-2025-000001`)
- Отправка карточки в служебный чат поддержки (`SUPPORT_CHAT_ID`)
- Интеграция с Bitrix24:
  - создание/обновление задач через Webhook API
  - экспорт статистики и выгрузка в CSV
- Админ-панель для просмотра и экспорта заявок
- Логика dev/prod-режимов через переменные окружения

---

## Сценарий пользователя

1. Пользователь отправляет `/start`.
2. Выбирает язык интерфейса (RU / UZ / EN).
3. Подтверждает согласие на обработку персональных данных.
4. Вводит ФИО (валидация по длине и допустимым символам).
5. Вводит номер телефона (проверка, что указано достаточно цифр).
6. Выбирает категорию обращения (препятствие работе, ИТ-проблема, HR-вопрос и т.д.).
7. Описывает суть обращения (минимальная длина текста, защита от “бла-бла” на 3 слова).
8. При необходимости прикрепляет вложения (фото, видео, документы, голосовые сообщения).
9. На экране проверки видит собранную карточку (ФИО, телефон, категория, текст, количество вложений).
10. Подтверждает отправку — бот:
    - генерирует уникальный ID обращения,
    - формирует текст карточки,
    - отправляет её в служебный чат поддержки,
    - при включённой интеграции — создаёт/обновляет задачу в Bitrix24.


## Сценарий администратора

Админ-панель реализована через отдельные команды и меню для пользователей из списка `ADMIN_IDS`:

- Просмотр последних обращений
- Фильтрация/выборка по периоду (через `EXPORT_LOOKBACK`)
- Экспорт обращений в CSV (для последующего анализа, отчётности и т.п.)
- Служебные команды для проверки доступности Bitrix24 и статуса интеграции

Админские команды вынесены в отдельный модуль `handlers_admin.py`, чтобы не смешивать пользовательскую и служебную логику.


## Клонировать репозиторий

git clone https://github.com/RiobVO/project_roote.git
cd project_roote

## Создать виртуальное окружение и установить зависимости

python -m venv .venv

# Активировать окружение:
# Windows (PowerShell):
.venv\Scripts\Activate.ps1

# Windows (cmd):
.venv\Scripts\activate

# Linux / macOS:
source .venv/bin/activate

pip install -r requirements.txt

## Настроить конфигурацию

cp app/.env.example app/.env.dev
# на Windows можно использовать:
# copy app\.env.example app\.env.dev

Отредактировать файл app/.env.dev и подставить свои значения токена бота, ID служебного чата, админов и параметров Bitrix24 (см. раздел ниже).

## Запустить бота

python app/main.py

## Стек

- **Python 3.10+**
- **[aiogram](https://docs.aiogram.dev)** — Telegram Bot API
- **Bitrix24 Webhook API** — интеграция с задачами и/или смарт-процессами
- **`python-dotenv`** — конфигурация через `.env`
- **FSM (Finite State Machine)** — управление состояниями формы заявок


## Архитектура проекта

```text
app/
  bot_core.py       # инициализация бота, диспетчера и роутеров
  config.py         # загрузка настроек из .env.dev / .env
  handlers_user.py  # пользовательские сценарии (FSM-форма обращения)
  handlers_admin.py # админские команды, экспорт статистики и заявок
  keyboards.py      # inline/reply-клавиатуры
  localization.py   # тексты и словари для RU / UZ / EN
  states.py         # определения состояний FSM
  helpers.py        # валидация, генерация ID, форматирование карточек
  bitrix_api.py     # обёртка над Bitrix24 Webhook API
  main.py           # точка входа (запуск бота)
